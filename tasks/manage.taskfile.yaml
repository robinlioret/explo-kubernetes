version: "3"

tasks:
  obj:new:
    internal: true
    preconditions:
      - sh: |
          [[ "{{ .NAME }}" =~ ^[a-z][a-z0-9\-]+[a-z0-9]$ ]]
        msg: >-
          Invalid NAME provided: "{{ .NAME }}".
          Must match ^[a-z][a-z0-9\-]+[a-z0-9]$

    status:
      - test -d ./{{ .KIND_PLURAL }}/{{ .NAME }}

    cmds:
      - mkdir -p ./{{ .KIND_PLURAL }}/{{ .NAME }}
      - cp -r ./templates/{{ .KIND_SINGULAR }}/* ./{{ .KIND_PLURAL }}/{{ .NAME }}/
      - yq -y -i '.includes += {"{{ .KIND_KEY }}:{{ .NAME }}":{"taskfile":"./{{ .KIND_PLURAL }}/{{.NAME}}/taskfile.yaml","dir":"./{{ .KIND_PLURAL }}/{{.NAME}}"}}' taskfile.yaml

  obj:delete:
    internal: true
    prompt: You're about to delete one {{ .KIND_SINGULAR }} (folder and associated tasks)... Do you wish to continue?
    preconditions:
      - sh: |
          [[ "{{ .NAME }}" =~ ^[a-z][a-z0-9\-]+[a-z0-9]$ ]]
        msg: >-
          Invalid NAME provided: "{{ .NAME }}".
          Must match ^[a-z][a-z0-9\-]+[a-z0-9]$

    status:
      - test ! -d ./{{ .KIND_PLURAL }}/{{ .NAME }}

    cmds:
      - rm -rf ./{{ .KIND_PLURAL }}/{{ .NAME }}/
      - yq -yi 'del(.includes["{{ .KIND_KEY }}:{{ .NAME }}"])' taskfile.yaml

  brick:new:
    desc: Create a brick folder and associated tasks.
    summary: |
      Create a brick folder and associated tasks. Name must be specify in an environment variable:
      NAME=my-brick task manage:brick:new
    cmds:
      - task: obj:new
        vars:
          KIND_PLURAL: bricks
          KIND_SINGULAR: brick
          KIND_KEY: brick

  brick:delete:
    desc: Delete the brick folder and associated tasks.
    summary: |
      Delete the brick folder and associated tasks. Name must be specify in an environment variable:
      NAME=my-brick task manage:brick:delete
    cmds:
      - task: obj:delete
        vars:
          KIND_PLURAL: bricks
          KIND_SINGULAR: brick
          KIND_KEY: brick

  env:new:
    desc: Create an environment folder and associated tasks.
    summary: |
      Create an environment folder and associated tasks. Name must be specify in an environment variable:
      NAME=my-env task manage:env:new
    cmds:
      - task: obj:new
        vars:
          KIND_PLURAL: environments
          KIND_SINGULAR: environment
          KIND_KEY: env

  env:delete:
    desc: Delete the environment folder and associated tasks.
    summary: |
      Delete the environment folder and associated tasks. Name must be specify in an environment variable:
      NAME=my-env task manage:env:delete
    cmds:
      - task: obj:delete
        vars:
          KIND_PLURAL: environments
          KIND_SINGULAR: environment
          KIND_KEY: env

  full-init:
    desc: Run multiple initialization tasks
    cmds:
      - task: check-installation
      - task: init-environement-variables
      - task: init-todo

  check-installation:
    desc: Check if all the dependencies of the taskfiles are available.
    silent: true
    preconditions:
      - sh: docker --help > /dev/null
        msg: Docker installation is invalid. See https://taskfile.dev/installation/
      - sh: kind --help > /dev/null
        msg: Kind installation is invalid. See https://kind.sigs.k8s.io/docs/user/quick-start/
      - sh: kubectl --help > /dev/null
        msg: Kubectl installation is invalid. See https://kubernetes.io/fr/docs/tasks/tools/install-kubectl/
      - sh: helm --help > /dev/null
        msg: Helm installation is invalid. See https://helm.sh/docs/intro/install/
      - sh: yq --help > /dev/null
        msg: Yq installation is invalid. See https://mikefarah.gitbook.io/yq

    cmds: []

  init-environement-variables:
    desc: Create a .env file at the root with the basic variables
    status:
      - test -f .env

    cmds:
      - |
        cat > .env << EOF
        export ROOT_DIR="$(pwd)"
        export ENVIRONMENT_TASK=base
        export KIND_CLUSTER_NAME=sandbox
        EOF

  init-todo:
    desc: Initialize a TODO.md file
    cmds:
      - rm {{ .ROOT_DIR }}/TODO.md
      - touch {{ .ROOT_DIR }}/TODO.md

  add-todo:
    desc: Add a TODO to the TODO.md file
    requires:
      vars:
        - CONTENT
    status:
      - grep -q "{{ .CONTENT }}$" {{ .ROOT_DIR }}/TODO.md

    cmd: echo "-[ ] {{ .CONTENT }}" >> {{ .ROOT_DIR }}/TODO.md
